"use strict";(self.webpackChunklunar_calendar=self.webpackChunklunar_calendar||[]).push([[205],{205:(e,t,s)=>{s.d(t,{rateLimitedFirebaseOperations:()=>l,rateLimiter:()=>o});var i=s(45),n=s(220),r=s(751),a=s(469);const o=new class{constructor(){this.requests=new Map,this.limits={auth:{max:100,window:6e4},firestore:{max:1e3,window:6e4},storage:{max:500,window:6e4},general:{max:2e3,window:6e4}},this.queues=new Map,this.processing=!1}canMakeRequest(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"general",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const s=Date.now(),i=t?`${e}_${t}`:e;this.requests.has(i)||this.requests.set(i,[]);const n=this.requests.get(i),r=this.limits[e]||this.limits.general,a=n.filter((e=>s-e<r.window));return this.requests.set(i,a),a.length<r.max}recordRequest(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"general",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const s=t?`${e}_${t}`:e;this.requests.has(s)||this.requests.set(s,[]),this.requests.get(s).push(Date.now())}getWaitTime(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"general",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const s=t?`${e}_${t}`:e;if(!this.requests.has(s))return 0;const i=this.requests.get(s),n=this.limits[e]||this.limits.general,r=Date.now(),a=i.filter((e=>r-e<n.window));if(a.length<n.max)return 0;return Math.min(...a)+n.window-r}async queueOperation(e){let t=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const s=`${arguments.length>1&&void 0!==arguments[1]?arguments[1]:"general"}_${(arguments.length>2&&void 0!==arguments[2]?arguments[2]:null)||"anonymous"}`;this.queues.has(s)||this.queues.set(s,[]);const i=this.queues.get(s);return new Promise(((n,r)=>{const a={operation:e,priority:t,resolve:n,reject:r,timestamp:Date.now()};let o=!1;for(let e=0;e<i.length;e++)if(t>i[e].priority){i.splice(e,0,a),o=!0;break}o||i.push(a),this.processQueue(s)}))}async processQueue(e){if(this.processing)return;this.processing=!0;const t=this.queues.get(e);for(;t.length>0;){const i=t[0],[n,r]=e.split("_");if(!this.canMakeRequest(n,r)){const e=this.getWaitTime(n,r);e>0&&await new Promise((t=>setTimeout(t,e)))}try{this.recordRequest(n,r);const e=await i.operation();i.resolve(e)}catch(s){i.reject(s)}t.shift(),await new Promise((e=>setTimeout(e,10)))}this.processing=!1}getStats(){const e={};for(const[s,i]of this.requests.entries()){var t;const n=Date.now(),[r,a]=s.split("_"),o=this.limits[r]||this.limits.general,l=i.filter((e=>n-e<o.window)),u=l.length/o.max*100;e[s]={current:l.length,limit:o.max,usage:Math.round(100*u)/100,queueLength:(null===(t=this.queues.get(s))||void 0===t?void 0:t.length)||0}}return e}cleanup(){const e=Date.now();for(const[t,s]of this.requests.entries()){const[i]=t.split("_"),n=this.limits[i]||this.limits.general,r=s.filter((t=>e-t<n.window));this.requests.set(t,r)}}},l={signInWithEmailAndPassword:async(e,t,s)=>o.queueOperation((()=>(0,i.signInWithEmailAndPassword)(e,t,s)),"auth",t),async getDoc(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return o.queueOperation((()=>(0,n.getDoc)(e)),"firestore",t)},async setDoc(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return o.queueOperation((()=>(0,n.BN)(e,t)),"firestore",s)},async uploadBytes(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return o.queueOperation((()=>(0,r.D)(e,t)),"storage",s)},async batchOperation(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return o.queueOperation((async()=>{const t=(0,n.wP)(a.db);return e.forEach((e=>{"set"===e.type?t.set(e.ref,e.data):"update"===e.type?t.update(e.ref,e.data):"delete"===e.type&&t.delete(e.ref)})),await t.commit()}),"firestore",t,1)}};new Map;setInterval((()=>{o.cleanup()}),6e4)}}]);